# 医疗器械医美新闻收集工作流

## 功能说明

本工作流用于自动收集医疗器械和医美相关的新闻，整理为Excel表格并通过邮件发送。

### 主要功能

1. **新闻收集**：从多个权威新闻来源网站收集医疗器械和医美相关新闻
2. **内容提取**：使用AI提取新闻摘要、关键词、来源和地区信息
3. **智能去重**：基于URL和标题相似度进行双重去重
4. **日期过滤**：只保留近3个月内的新闻
5. **表格生成**：自动生成Excel表格，包含所有关键字段
6. **邮件发送**：将新闻汇总和Excel附件发送到指定邮箱

## 新闻来源网站

工作流支持从以下12个权威新闻来源网站收集新闻：

| 序号 | 网站名称 | 域名 | 网址 |
|------|---------|------|------|
| 1 | 今日头条 | toutiao.com | https://www.toutiao.com |
| 2 | 搜狐 | sohu.com | https://www.sohu.com |
| 3 | 腾讯网 | qq.com | https://www.qq.com |
| 4 | 网易新闻 | 163.com | https://www.163.com |
| 5 | 凤凰网 | ifeng.com | https://www.ifeng.com |
| 6 | 澎湃新闻网 | thepaper.cn | https://www.thepaper.cn |
| 7 | 新浪财经 | finance.sina.com.cn | https://finance.sina.com.cn |
| 8 | 新浪网 | sina.com.cn | https://www.sina.com.cn |
| 9 | 环球网 | ylqx.qgyyzs.net | https://ylqx.qgyyzs.net |
| 10 | 医疗器械行业协会 | camdi.cn | http://www.camdi.cn |
| 11 | 东方医疗器械网 | qxw18.com | https://www.qxw18.com |
| 12 | 央视网 | cctv.com | https://www.cctv.com |

## 使用方法

### 运行工作流

```bash
bash scripts/local_run.sh -m flow
```

### 工作流输入参数

运行工作流时需要提供以下参数：

#### 1. 邮箱地址（必填）
- **参数名**：`emails`
- **类型**：字符串
- **说明**：接收邮件的邮箱地址，多个邮箱用逗号分隔
- **示例**：`user1@example.com,user2@example.com`

#### 2. 新闻来源网站（可选，多选）
- **参数名**：`selected_sites`
- **类型**：多选列表
- **说明**：选择要从中收集新闻的网站
- **默认值**：所有12个网站全选
- **可选值**：
  - `toutiao.com` - 今日头条
  - `sohu.com` - 搜狐
  - `qq.com` - 腾讯网
  - `163.com` - 网易新闻
  - `ifeng.com` - 凤凰网
  - `thepaper.cn` - 澎湃新闻网
  - `finance.sina.com.cn` - 新浪财经
  - `sina.com.cn` - 新浪网
  - `ylqx.qgyyzs.net` - 环球网
  - `camdi.cn` - 医疗器械行业协会
  - `qxw18.com` - 东方医疗器械网
  - `cctv.com` - 央视网

### 输出示例

成功运行后，工作流将返回以下信息：

```json
{
  "synced_count": 15,
  "email_sent": true,
  "message": "邮件已成功发送到所有 1 个收件人，包含 15 条新闻（仅第一个邮箱含Excel附件）"
}
```

## 工作流结构

```
┌─────────────────┐
│  split_emails   │  分割邮箱地址
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   fetch_news    │  从选定网站获取新闻
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  extract_date   │  过滤近3个月内新闻
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│deduplicate_news │  去除历史重复新闻
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│extract_news_info│  提取摘要、关键词等
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  create_table   │  生成Excel表格
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   send_email    │  发送邮件通知
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│save_news_history│  保存历史记录
└─────────────────┘
```

## 邮件发送说明

- **发件人名称**：Huxg
- **附件**：仅第一个收件人接收Excel附件，其他收件人仅接收邮件正文
- **邮件格式**：同时发送HTML和纯文本两个版本，确保兼容性
- **无新闻时**：即使没有收集到新新闻，也会发送通知邮件

## Excel表格字段

生成的Excel表格包含以下字段：

| 字段名 | 说明 | 示例 |
|--------|------|------|
| 标题 | 新闻标题 | XXX公司发布新款医疗设备 |
| 日期 | 新闻发布日期 | 2024-01-15 |
| 来源 | 新闻来源机构 | 新浪财经 |
| 地区 | 地区信息 | 北京 |
| 关键词 | AI提取的关键词 | 医疗器械、创新、上市 |
| 链接 | 新闻原文链接 | https://... |
| 摘要 | AI生成的新闻摘要 | XXX公司今日宣布... |

## 注意事项

1. **新闻来源选择**：建议至少选择3-5个网站，以获得更全面的新闻覆盖
2. **历史去重**：工作流会自动与历史记录比对，避免发送重复新闻
3. **数据质量**：新闻摘要、关键词等信息由AI生成，仅供参考
4. **邮件发送**：确保邮件配置正确（SMTP服务器、账号、授权码）
5. **定时运行**：建议配置为每天早上6点自动运行

## 常见问题

### Q: 为什么收到的邮件没有内容？
A: 请检查邮件客户端是否支持HTML格式。邮件同时发送了HTML和纯文本两个版本，如果HTML不被渲染，应该能看到纯文本版本。

### Q: 为什么没有收集到新闻？
A: 可能的原因：
1. 选定的网站暂时没有相关新闻
2. 所有新闻已在之前发送过（已去重）
3. 网络搜索服务暂时不可用
4. 建议尝试选择其他网站

### Q: 可以只从某个特定网站收集新闻吗？
A: 可以，在运行工作流时，在"新闻来源网站"多选框中只选择需要的网站即可。

### Q: 如何增加新的新闻来源网站？
A: 需要修改 `src/graphs/state.py` 中的 `AVAILABLE_NEWS_SITES` 列表和 `src/graphs/node.py` 中的 `fetch_news_node` 函数。

## 更新日志

### v2.0.0 (2024-01-XX)
- ✨ 新增新闻来源网站多选功能
- ✨ 新增7个新闻来源网站（澎湃、新浪财经、新浪、环球网、医疗器械行业协会、东方医疗器械网、央视网）
- 🐛 修复邮件内容为空的问题
- 🐛 修复HTML邮件兼容性问题
- ♻️ 优化节点顺序，先过滤日期再进行历史去重

### v1.0.0
- 🎉 初始版本发布
- ✨ 支持5个新闻来源网站
- ✨ 自动收集、整理、发送新闻
- ✨ 智能去重和日期过滤
