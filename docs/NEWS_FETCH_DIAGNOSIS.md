# 新闻获取模块诊断指南

## 问题描述

获取新闻模块（fetch_news_node）没有输出或返回空结果。

## 诊断步骤

### 步骤 1：查看执行日志

在 Coze 平台查看工作流执行日志：

1. 登录 Coze 平台
2. 打开你的工作流
3. 点击"运行历史"或"日志"标签
4. 查找最近的一次执行记录
5. 点击进入查看详细日志

**关键日志标记**：
- `============================================================` - 节点开始/结束标记
- `环境变量检查` - 检查 API Key 和 Base URL 是否配置
- `[批次1-X/Y] 开始搜索` - 每次搜索的开始
- `✅ 成功获取到` - 搜索成功
- `❌ 搜索失败` - 搜索失败
- `新闻去重后统计` - 最终结果统计

---

### 步骤 2：根据日志诊断问题

#### 情况 1：日志显示"❌ 错误: 缺少必要的环境变量"

**症状**：
```
❌ 错误: 缺少必要的环境变量：COZE_WORKLOAD_IDENTITY_API_KEY 或 COZE_INTEGRATION_BASE_URL
```

**原因**：
- Coze 平台的环境变量未正确注入
- 在非 Coze 环境运行（如本地），未手动配置环境变量

**解决方案**：

**在 Coze 平台运行（推荐）**：
- 确保工作流部署在 Coze 平台
- 不要在本地或 GitHub Actions 直接运行代码
- 使用 GitHub Actions 调用 Coze API 的方式部署

**在本地运行**（测试用）：
```bash
export COZE_WORKLOAD_IDENTITY_API_KEY="your_api_key_here"
export COZE_INTEGRATION_BASE_URL="https://your-api-url"
python src/main.py --emails "test@example.com"
```

---

#### 情况 2：所有搜索都显示"❌ 搜索失败"

**症状**：
```
[批次1-1/5] 开始搜索: '医疗器械公司'
  目标网站: toutiao.com|sohu.com|qq.com|163.com|ifeng.com
  ❌ 搜索失败: 网络请求失败: ...
```

**可能原因**：

**A. API Key 无效**
- API Key 已过期或被撤销
- API Key 权限不足

**解决方案**：
1. 检查 Coze 平台的 API Key 配置
2. 重新生成 API Key
3. 确认 API Key 有"网络搜索"权限

**B. Base URL 配置错误**
- Base URL 地址不正确
- 网络连接问题

**解决方案**：
1. 检查 `COZE_INTEGRATION_BASE_URL` 配置
2. 在 Coze 平台通常无需手动配置
3. 测试网络连接

**C. 搜索服务暂时不可用**
- Coze 搜索服务维护中
- API 限流

**解决方案**：
1. 等待几分钟后重试
2. 联系 Coze 平台客服

---

#### 情况 3：所有搜索都成功，但返回 0 条新闻

**症状**：
```
[批次1-1/5] 开始搜索: '医疗器械公司'
  目标网站: toutiao.com|sohu.com|qq.com|163.com|ifeng.com
  ✅ 成功获取到 0 条新闻
```

**可能原因**：

**A. 搜索词匹配不到新闻**
- 搜索词过于精确或过于宽泛
- 目标网站最近没有相关新闻

**解决方案**：
1. 修改搜索词，使用更通用的词汇
2. 增加搜索词列表
3. 修改搜索时间范围（添加 `time_range` 参数）

**B. 目标网站限制**
- 某些网站限制爬虫访问
- 网站结构变化导致搜索失败

**解决方案**：
1. 更换其他新闻源
2. 移除有问题的网站

---

#### 情况 4：搜索成功，但最终返回空列表

**症状**：
```
搜索完成统计:
  成功: 15 个查询
  失败: 0 个查询
  原始新闻总数: 0 条

⚠️ 警告: 所有搜索查询都没有获取到新闻！

新闻去重后统计:
  去重前: 0 条
  URL去重后: 0 条
  标题去重后: 0 条

❌ 最终没有返回任何新闻
```

**可能原因**：
- 所有搜索词都没有匹配到新闻
- 所有新闻都超过了时间范围
- 所有新闻都被去重逻辑过滤

**解决方案**：
1. 检查搜索词是否合理
2. 调整 `time_range` 参数，扩大搜索时间范围
3. 在 Coze 平台手动搜索测试

---

#### 情况 5：日志完全没有输出

**症状**：
- 节点没有任何日志输出
- 其他节点正常运行

**可能原因**：
- 节点未正确连接到工作流
- 节点代码有语法错误

**解决方案**：
1. 检查工作流图，确认节点连接正确
2. 在 Coze 平台检查节点代码
3. 查看是否有编译错误

---

### 步骤 3：常见错误排查

#### 错误 1：`网络请求失败: HTTPConnectionPool`

**原因**：网络连接问题

**解决方案**：
1. 检查网络连接
2. 检查 Base URL 是否可访问
3. 尝试使用代理

#### 错误 2：`web_search 失败: API调用失败`

**原因**：API 调用被拒绝

**解决方案**：
1. 检查 API Key 权限
2. 检查是否超过 API 调用频率限制
3. 联系 Coze 平台客服

#### 错误 3：`AttributeError: 'NoneType' object has no attribute 'xxx'`

**原因**：返回的数据结构不正确

**解决方案**：
1. 检查 API 响应格式是否变化
2. 添加空值检查
3. 更新 `web_search_tool.py` 代码

---

### 步骤 4：手动测试

#### 方法 1：在 Coze 平台手动触发

1. 打开工作流
2. 点击"手动运行"或"调试"
3. 输入测试邮箱地址
4. 查看执行日志

#### 方法 2：使用 Python 脚本测试

创建测试脚本 `test_news_fetch.py`：

```python
import os
from tools.web_search_tool import web_search
from coze_coding_utils.runtime_ctx.context import new_context

# 设置环境变量（如果在本地测试）
os.environ["COZE_WORKLOAD_IDENTITY_API_KEY"] = "your_api_key"
os.environ["COZE_INTEGRATION_BASE_URL"] = "https://api.coze.cn"

ctx = new_context(method="test")

# 测试搜索
try:
    web_items, summary, _, _ = web_search(
        ctx=ctx,
        query="医疗器械",
        search_type="web",
        count=10,
        need_summary=True,
        need_content=True
    )
    
    print(f"成功获取到 {len(web_items)} 条新闻")
    for idx, item in enumerate(web_items, 1):
        print(f"{idx}. {item.Title}")
        print(f"   URL: {item.Url}")
        print(f"   日期: {item.PublishTime}")
        print()
        
except Exception as e:
    print(f"搜索失败: {e}")
    import traceback
    traceback.print_exc()
```

运行测试：
```bash
python test_news_fetch.py
```

---

### 步骤 5：联系技术支持

如果以上步骤都无法解决问题，请提供以下信息：

1. **完整的工作流执行日志**
   - 特别是 `fetch_news_node` 节点的日志

2. **环境配置**
   - 运行环境（Coze 平台/本地/GitHub Actions）
   - API Key 是否配置
   - Base URL 配置

3. **错误信息**
   - 完整的错误堆栈信息
   - 截图（如果有）

4. **复现步骤**
   - 如何触发问题
   - 问题出现的频率

**技术支持渠道**：
- Coze 平台官方客服
- Coze 平台技术支持文档
- 项目 GitHub Issues

---

## 预防措施

### 1. 定期检查日志

建议每天查看一次工作流执行日志，及时发现异常。

### 2. 监控 API 调用

定期检查 API 调用统计，避免超出限额。

### 3. 备份配置

定期备份搜索词、新闻源等配置，方便恢复。

### 4. 优化搜索词

根据实际效果调整搜索词，提高搜索命中率。

---

## 附录：日志示例

### 成功的日志示例

```
============================================================
开始执行 fetch_news_node - 获取新闻
============================================================
环境变量检查:
  API Key: ✅ 已配置
  Base URL: ✅ 已配置
  Base URL 值: https://api.coze.cn

开始搜索新闻，第一批次网站: toutiao.com|sohu.com|qq.com|163.com|ifeng.com

[批次1-1/5] 开始搜索: '医疗器械公司'
  目标网站: toutiao.com|sohu.com|qq.com|163.com|ifeng.com
  ✅ 成功获取到 10 条新闻
     - 医疗器械公司XX获得千万级融资，加速产品研发...
     - 某某医疗器械公司发布新品，市场反应热烈...
     - 医疗器械行业政策解读...
     ... 还有 7 条

[批次1-2/5] 开始搜索: '医疗器械产品'
  目标网站: toutiao.com|sohu.com|qq.com|163.com|ifeng.com
  ✅ 成功获取到 8 条新闻
     - 新型医疗器械产品获批上市...
     ...

============================================================
搜索完成统计:
  成功: 15 个查询
  失败: 0 个查询
  原始新闻总数: 120 条
============================================================

============================================================
新闻去重后统计:
  去重前: 120 条
  URL去重后: 95 条
  标题去重后: 85 条
============================================================

✅ 最终返回 85 条新闻:
  1. [2025-01-15] 医疗器械公司XX获得千万级融资...
  2. [2025-01-15] 某某医疗器械公司发布新品...
  3. [2025-01-14] 新型医疗器械产品获批上市...
  4. [2025-01-14] 医疗器械行业政策解读...
  5. [2025-01-13] 医美市场规模持续扩大...
  ... 还有 80 条新闻

============================================================
fetch_news_node 执行完成
============================================================
```

### 失败的日志示例

```
============================================================
开始执行 fetch_news_node - 获取新闻
============================================================
环境变量检查:
  API Key: ❌ 未配置
  Base URL: ❌ 未配置

❌ 错误: 缺少必要的环境变量：COZE_WORKLOAD_IDENTITY_API_KEY 或 COZE_INTEGRATION_BASE_URL
```

---

**更新时间**：2025-01-15
