name: News Collection Workflow

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹è‡ªåŠ¨è§¦å‘ï¼ˆUTCæ—¶é—´å‡Œæ™¨0ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      emails:
        description: 'æ¥æ”¶é‚®ä»¶çš„é‚®ç®±åœ°å€ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'your-email@example.com'

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Coze API to trigger workflow
        env:
          # Coze API é…ç½®
          COZE_API_TOKEN: ${{ secrets.COZE_API_TOKEN }}
          COZE_WORKFLOW_ID: ${{ secrets.COZE_WORKFLOW_ID }}
          COZE_API_BASE_URL: ${{ secrets.COZE_API_BASE_URL || 'https://api.coze.cn' }}
          # å·¥ä½œæµè¾“å…¥å‚æ•°
          EMAILS: ${{ github.event.inputs.emails || secrets.EMAILS }}
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

          echo "=========================================="
          echo "Coze API è°ƒç”¨é…ç½®"
          echo "=========================================="
          echo "API Base URL: ${COZE_API_BASE_URL}"
          echo "Workflow ID: ${COZE_WORKFLOW_ID}"
          echo "æ¥æ”¶é‚®ç®±: ${EMAILS}"
          echo "=========================================="

          # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$COZE_API_TOKEN" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªè®¾ç½® COZE_API_TOKEN ç¯å¢ƒå˜é‡"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® COZE_API_TOKEN"
            exit 1
          fi

          if [ -z "$COZE_WORKFLOW_ID" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªè®¾ç½® COZE_WORKFLOW_ID ç¯å¢ƒå˜é‡"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® COZE_WORKFLOW_ID"
            exit 1
          fi

          if [ -z "$EMAILS" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªè®¾ç½® EMAILS ç¯å¢ƒå˜é‡"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® EMAILSï¼Œæˆ–åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æä¾›é‚®ç®±åœ°å€"
            exit 1
          fi

          echo ""
          echo "ğŸš€ å¼€å§‹è°ƒç”¨ Coze API..."
          echo ""

          # è°ƒç”¨ Coze API è§¦å‘å·¥ä½œæµ
          RESPONSE=$(curl -s -X POST "${COZE_API_BASE_URL}/v1/workflow/run" \
            -H "Authorization: Bearer ${COZE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"workflow_id\": \"${COZE_WORKFLOW_ID}\",
              \"parameters\": {
                \"emails\": \"${EMAILS}\"
              },
              \"stream\": false
            }")

          echo "API å“åº”ï¼š"
          echo "${RESPONSE}" | jq '.'

          # æ£€æŸ¥ API è°ƒç”¨æ˜¯å¦æˆåŠŸ
          STATUS=$(echo "${RESPONSE}" | jq -r '.code // empty')

          if [ "$STATUS" != "0" ] && [ -n "$STATUS" ]; then
            echo ""
            echo "âŒ API è°ƒç”¨å¤±è´¥"
            echo "é”™è¯¯ä»£ç : ${STATUS}"
            echo "é”™è¯¯ä¿¡æ¯: $(echo "${RESPONSE}" | jq -r '.msg // .message // .error // empty')"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰è¿”å›ç»“æœ
          JOB_ID=$(echo "${RESPONSE}" | jq -r '.data.id // .data.job_id // empty')

          if [ -n "$JOB_ID" ]; then
            echo ""
            echo "âœ… å·¥ä½œæµå·²æˆåŠŸè§¦å‘"
            echo "Job ID: ${JOB_ID}"
            echo "ç­‰å¾…å·¥ä½œæµæ‰§è¡Œå®Œæˆ..."

            # è½®è¯¢å·¥ä½œæµçŠ¶æ€
            MAX_WAIT=900  # æœ€å¤šç­‰å¾… 15 åˆ†é’Ÿ
            WAIT_INTERVAL=10  # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
            ELAPSED=0

            while [ $ELAPSED -lt $MAX_WAIT ]; do
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))

              STATUS_RESPONSE=$(curl -s -X GET "${COZE_API_BASE_URL}/v1/workflow/jobs/${JOB_ID}" \
                -H "Authorization: Bearer ${COZE_API_TOKEN}")

              JOB_STATUS=$(echo "${STATUS_RESPONSE}" | jq -r '.data.status // empty')

              echo "[$(date +'%H:%M:%S')] å·¥ä½œæµçŠ¶æ€: ${JOB_STATUS}"

              if [ "$JOB_STATUS" = "succeeded" ]; then
                echo ""
                echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
                echo ""
                echo "æœ€ç»ˆç»“æœï¼š"
                echo "${STATUS_RESPONSE}" | jq '.data.outputs // .data.result // empty'
                break
              elif [ "$JOB_STATUS" = "failed" ]; then
                echo ""
                echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
                echo "é”™è¯¯ä¿¡æ¯ï¼š"
                echo "${STATUS_RESPONSE}" | jq '.data.error // .data.outputs // empty'
                exit 1
              elif [ "$JOB_STATUS" = "running" ] || [ "$JOB_STATUS" = "pending" ]; then
                echo "â³ å·¥ä½œæµæ‰§è¡Œä¸­..."
                continue
              else
                echo "âš ï¸  æœªçŸ¥çŠ¶æ€: ${JOB_STATUS}"
                echo "çŠ¶æ€è¯¦æƒ…ï¼š"
                echo "${STATUS_RESPONSE}"
                exit 1
              fi
            done

            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo ""
              echo "âš ï¸  å·¥ä½œæµæ‰§è¡Œè¶…æ—¶ï¼ˆè¶…è¿‡ ${MAX_WAIT} ç§’ï¼‰"
              echo "å·¥ä½œæµä»åœ¨åå°è¿è¡Œï¼ŒJob ID: ${JOB_ID}"
              exit 1
            fi
          else
            echo ""
            echo "âš ï¸  æœªèƒ½è·å– Job IDï¼Œå¯èƒ½å·¥ä½œæµå·²åŒæ­¥è¿”å›ç»“æœ"
            echo "æœ€ç»ˆè¾“å‡ºï¼š"
            echo "${RESPONSE}" | jq '.data.outputs // .data.result // .data // empty'
          fi

          echo ""
          echo "=========================================="
          echo "ğŸ‰ ä»»åŠ¡å®Œæˆï¼"
          echo "=========================================="
